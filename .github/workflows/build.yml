name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from (default: main)'
        required: false
        default: 'main'
      version:
        description: 'Version number (X.X.X)'
        required: true
      build_native:
        description: 'Build Native version'
        type: boolean
        required: false
        default: true
      build_curseforge:
        description: 'Build CurseForge version'
        type: boolean
        required: false
        default: true
      build_modrinth:
        description: 'Build Modrinth version'
        type: boolean
        required: false
        default: true
      release_type:
        description: 'Release type'
        type: choice
        options:
        - release
        - pre-release
        - latest-release
        required: true
        default: 'release'

env:
  PACK_NAME: 'NTNH'
  # Use the PAT for everything that needs write access
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  setup-and-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      commit_hash: ${{ steps.get-commit.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          # Explicitly use the PAT token for checkout to enable push permissions
          token: ${{ secrets.GH_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Update version in pack.toml
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Setting version to: $VERSION"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pack.toml
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run packwiz refresh
        run: packwiz refresh

      - name: Commit and push version changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add pack.toml index.toml
          git commit -m "Update version to ${{ github.event.inputs.version }}"
          git push origin ${{ github.event.inputs.branch || 'main' }}

      - name: Get commit hash
        id: get-commit
        run: echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  build-native:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_native == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          # Use PAT for checkout to ensure consistent permissions
          token: ${{ secrets.GH_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Export Native modpack
        run: |
          packwiz export --output "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip" --format zip

      - name: Clean up Native zip (remove .toml files)
        run: |
          # Extract the zip
          mkdir native_temp
          unzip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip" -d native_temp
          
          # Remove all .toml files from mods directory
          find native_temp/mods -name "*.toml" -type f -delete
          
          # For each .toml file in mods, delete corresponding .jar if it exists
          for toml_file in native_temp/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="native_temp/mods/${base_name}.jar"
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate jar: $jar_file"
                rm "$jar_file"
              fi
            fi
          done
          
          # Remove .toml files from root and other directories
          find native_temp -name "*.toml" -type f -delete
          
          # Recreate the zip
          cd native_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip" .
          cd ..
          
          # Clean up temp directory
          rm -rf native_temp

      - name: Upload Native artifact
        uses: actions/upload-artifact@v3
        with:
          name: native-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip"

  build-curseforge:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_curseforge == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Export CurseForge modpack
        run: |
          packwiz cf export
          mv export.zip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"

      - name: Clean up CurseForge zip (remove duplicate jars)
        run: |
          # Extract the zip
          mkdir cf_temp
          unzip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip" -d cf_temp
          
          # For each .toml file in mods, delete corresponding .jar if it exists
          for toml_file in cf_temp/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="cf_temp/mods/${base_name}.jar"
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate jar: $jar_file"
                rm "$jar_file"
              fi
            fi
          done
          
          # Recreate the zip
          cd cf_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip" .
          cd ..
          
          # Clean up temp directory
          rm -rf cf_temp

      - name: Upload CurseForge artifact
        uses: actions/upload-artifact@v3
        with:
          name: curseforge-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"

  build-modrinth:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_modrinth == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Export Modrinth modpack
        run: |
          packwiz mr export
          mv export.mrpack "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"

      - name: Clean up Modrinth zip (remove duplicate jars)
        run: |
          # Extract the zip
          mkdir mr_temp
          unzip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip" -d mr_temp
          
          # For each .toml file in mods, delete corresponding .jar if it exists
          for toml_file in mr_temp/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="mr_temp/mods/${base_name}.jar"
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate jar: $jar_file"
                rm "$jar_file"
              fi
            fi
          done
          
          # Recreate the zip
          cd mr_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip" .
          cd ..
          
          # Clean up temp directory
          rm -rf mr_temp

      - name: Upload Modrinth artifact
        uses: actions/upload-artifact@v3
        with:
          name: modrinth-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"

  create-release:
    needs: 
      - setup-and-version
      - build-native
      - build-curseforge
      - build-modrinth
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Get changelog content
        id: get-changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_CONTENT=$(cat CHANGELOG.md)
            echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog_content=No changelog available" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup-and-version.outputs.version }}
          name: ${{ needs.setup-and-version.outputs.version }}
          body: ${{ steps.get-changelog.outputs.changelog_content }}
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          files: |
            artifacts/native-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip
            artifacts/curseforge-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip
            artifacts/modrinth-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
