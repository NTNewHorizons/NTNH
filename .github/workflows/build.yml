name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: 'Version number (e.g., 1.2.0)'
      branch:
        type: string
        required: true
        description: 'Branch to build from (e.g., main)'
      is_latest:
        type: boolean
        required: false
        default: false
        description: 'Set as latest release on GitHub'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}

      # 2. Create and push tag
      - name: Create tag
        run: |
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      # 3. Build all formats
      - name: Build Archives
        run: |
          # Убедимся, что директории существуют
          mkdir -p ./build
          cp -r ./mods ./config ./scripts ./serverutilities ./shaderpacks ./build/

          # Общие файлы
          cp icon.png ./build/
          cp oauthprofiles.json ./build/

          # 1. NTNH-X.X.X-Native.zip
          zip -r "NTNH-${{ inputs.version }}-Native.zip" ./build/

          # 2. Modrinth mrpack
          mkdir -p ./build-modrinth
          cp -r ./build/* ./build-modrinth/
          echo '{"manifest": {"format_version": 1, "name": "NTNH", "version": "${{ inputs.version }}", "author": "Your Name", "description": "NTNH modpack", "files": []}}' > ./build-modrinth/modrinth.json
          zip -r "NTNH-${{ inputs.version }}-Modrinth.mrpack" ./build-modrinth/

          # 3. CurseForge zip
          mkdir -p ./build-curseforge
          cp -r ./build/* ./build-curseforge/
          echo '{"manifest": {"format_version": 1, "name": "NTNH", "version": "${{ inputs.version }}", "author": "Your Name", "description": "NTNH modpack", "files": []}}' > ./build-curseforge/curseforge.json
          zip -r "NTNH-${{ inputs.version }}-Curseforge.zip" ./build-curseforge/

          # 4. MMC/PrismLauncher
          mkdir -p ./build-mmc
          cp -r ./build/* ./build-mmc/
          echo '{"name": "NTNH", "version": "${{ inputs.version }}", "icon": "icon.png", "modList": [], "overrides": "."}' > ./build-mmc/mmc-pack-profile.json
          zip -r "NTNH-${{ inputs.version }}-MMC_Prism.zip" ./build-mmc/

          # Сохраняем архивы в рабочей директории
          mv *.zip ./

      # 4. Publish release
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ inputs.version }}
          name: NTNH ${inputs.version}
          body: |
            $(cat CHANGELOG.txt)
          files: |
            NTNH-${{ inputs.version }}-Native.zip
            NTNH-${{ inputs.version }}-Modrinth.mrpack
            NTNH-${{ inputs.version }}-Curseforge.zip
            NTNH-${{ inputs.version }}-MMC_Prism.zip
          latest: ${{ inputs.is_latest }}
