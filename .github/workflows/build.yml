name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'experiments/packwiz'
        type: string
      version:
        description: 'Version tag (e.g. 2.3.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - pre-release
          - latest
      curseforge_build:
        description: 'Generate CurseForge build'
        required: true
        default: 'true'
        type: boolean
      modrinth_build:
        description: 'Generate Modrinth build'
        required: true
        default: 'true'
        type: boolean
      native_build:
        description: 'Generate Native build (raw mod files in a ZIP)'
        required: true
        default: 'false'
        type: boolean

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: Nuclear-Tech-New-Horizons/NTNH
          ref: ${{ github.event.inputs.branch }}
          path: NTNH
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
        env:
          GOPATH: /home/runner/go

      - name: Add packwiz to PATH
        run: |
          echo "/home/runner/go/bin" >> $GITHUB_PATH

      - name: Update version in pack.toml
        run: |
          cd NTNH
          echo "Updating pack.toml with version: ${{ github.event.inputs.version }}"
          
          # Update the version field in pack.toml
          if [[ "$(uname)" == "Darwin" ]]; then
            # macOS version of sed
            sed -i '' "s/^version = .*/version = \"${{ github.event.inputs.version }}\"/" pack.toml
          else
            # Linux version of sed
            sed -i "s/^version = .*/version = \"${{ github.event.inputs.version }}\"/" pack.toml
          fi
          
          echo "Updated pack.toml:"
          cat pack.toml
        shell: bash

      - name: Run packwiz refresh
        run: |
          cd NTNH
          echo "Running packwiz refresh to update metadata and download mod files..."
          packwiz refresh
          echo "Packwiz refresh completed successfully"
        shell: bash

      - name: Prepare manual downloads (required for Modrinth export)
        if: ${{ github.event.inputs.modrinth_build == 'true' }}
        run: |
          cd NTNH
          echo "Creating cache directory for manual downloads..."
          mkdir -p /home/runner/.cache/packwiz/cache/import
          
          echo "Downloading Low On Fire texture pack..."
          wget -O /home/runner/.cache/packwiz/cache/import/LowOnFire_1.8.zip https://edge.forgecdn.net/files/4307/966/LowOnFire_1.8.zip    
          
          echo "Downloading Rails of War mod..."
          wget -O /home/runner/.cache/packwiz/cache/import/RailsOfWar-1.7.10-5.8-RC7.jar https://edge.forgecdn.net/files/2459/153/RailsOfWar-1.7.10-5.8-RC7.jar    
          
          echo "Manual downloads prepared successfully"
        shell: bash

      - name: Run CurseForge export (if selected)
        id: curseforge_export
        if: ${{ github.event.inputs.curseforge_build == 'true' }}
        run: |
          cd NTNH
          echo "Running packwiz curseforge export..."
          packwiz curseforge export
          
          # Find the generated export file - be format-agnostic
          export_file=$(find . -maxdepth 1 -name "*Nuclear Tech: New Horizons*${{ github.event.inputs.version }}*" -print -quit)
          
          # If not found by name, look for recently modified files with common extensions
          if [ -z "$export_file" ]; then
            echo "Could not find by name, searching by extension and modification time..."
            export_file=$(find . -maxdepth 1 -type f \( -name "*.zip" -o -name "*.jar" -o -name "*.mrpack" \) -mmin -1 -print -quit)
          fi
          
          if [ -z "$export_file" ]; then
            echo "No export file found after CurseForge export"
            echo "Listing directory contents for debugging:"
            ls -la
            exit 1
          fi
          
          # Clean up the filename (remove ./ prefix)
          clean_filename=$(basename "$export_file")
          echo "Found export file: $clean_filename"
          
          # Rename the file to NTNH-X.X.X-CurseForge.zip
          new_filename="NTNH-${{ github.event.inputs.version }}-CurseForge.zip"
          mv "$export_file" "$new_filename"
          echo "Renamed file to: $new_filename"
          
          echo "curseforge_file=$new_filename" >> $GITHUB_OUTPUT
          echo "CurseForge build generated: $new_filename"
        shell: bash

      - name: Run Modrinth export (if selected)
        id: modrinth_export
        if: ${{ github.event.inputs.modrinth_build == 'true' }}
        run: |
          cd NTNH
          echo "Running packwiz modrinth export..."
          packwiz modrinth export
          
          # Find the generated export file - be format-agnostic
          export_file=$(find . -maxdepth 1 -name "*Nuclear Tech: New Horizons*${{ github.event.inputs.version }}*" -print -quit)
          
          # If not found by name, look for recently modified files with common extensions
          if [ -z "$export_file" ]; then
            echo "Could not find by name, searching by extension and modification time..."
            export_file=$(find . -maxdepth 1 -type f \( -name "*.zip" -o -name "*.jar" -o -name "*.mrpack" \) -mmin -1 -print -quit)
          fi
          
          if [ -z "$export_file" ]; then
            echo "No export file found after Modrinth export"
            echo "Listing directory contents for debugging:"
            ls -la
            exit 1
          fi
          
          # Clean up the filename (remove ./ prefix)
          clean_filename=$(basename "$export_file")
          echo "Found export file: $clean_filename"
          
          # Rename the file to NTNH-X.X.X-Modrinth.mrpack
          new_filename="NTNH-${{ github.event.inputs.version }}-Modrinth.mrpack"
          mv "$export_file" "$new_filename"
          echo "Renamed file to: $new_filename"
          
          echo "modrinth_file=$new_filename" >> $GITHUB_OUTPUT
          echo "Modrinth build generated: $new_filename"
        shell: bash

      # --- NEW STEP: Create Native ZIP after packwiz refresh/downloads ---
      - name: Create Native ZIP (if selected)
        id: native_export
        if: ${{ github.event.inputs.native_build == 'true' }}
        run: |
          cd NTNH
          echo "Creating Native ZIP containing actual mod files..."
          
          # Define the name for the native zip file
          native_zip_name="NTNH-${{ github.event.inputs.version }}-Native.zip"
          
          # Check if the mods folder (or other expected folders) exist and contain files
          # Adjust the list of folders as needed for your modpack (e.g., resourcepacks/, config/, etc.)
          if [ -d "mods" ] && [ -n "$(ls -A mods)" ]; then
            echo "Found files in mods/ directory, adding to ZIP..."
          else
            echo "mods/ directory is empty or does not exist, checking other directories..."
            # You might want to add checks for other directories like resourcepacks/, config/, etc.
            # For now, if mods/ is missing, we can still create an empty zip or fail.
            # Let's fail if there's nothing to zip.
            if [ ! -d "mods" ] && [ ! -d "resourcepacks" ] && [ ! -d "config" ]; then
               echo "No standard directories (mods, resourcepacks, config) found to include in Native ZIP."
               ls -la
               exit 1
            fi
          fi
          
          # Use zip command to create the native zip file from the contents of the instance directory.
          # This includes the mods/ folder and any other standard Minecraft directories.
          # The -r flag makes it recursive, and . includes all contents of the current directory.
          echo "Zipping contents of NTNH/ directory to ${native_zip_name}..."
          zip -r "${native_zip_name}" . -x "pack.toml" "index.toml" "icon.png" "*.lock" ".git*" "*/.git*"
          
          # Check if the zip was created
          if [ -f "${native_zip_name}" ]; then
             echo "Native build generated: ${native_zip_name}"
             echo "native_file=${native_zip_name}" >> $GITHUB_OUTPUT
          else
             echo "Failed to create native zip file: ${native_zip_name}"
             ls -la
             exit 1
          fi
          
        shell: bash

      # --- END NEW STEP ---

      - name: Check for Mary-TTS.zip
        id: marytts_check
        run: |
          cd NTNH
          if [ -f "Mary-TTS.zip" ]; then
            echo "Mary-TTS.zip found in repository"
            echo "marytts_exists=true" >> $GITHUB_OUTPUT
            echo "marytts_file=Mary-TTS.zip" >> $GITHUB_OUTPUT
          else
            echo "Mary-TTS.zip not found in repository"
            echo "marytts_exists=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Read CHANGELOG
        id: changelog
        run: |
          cd NTNH
          if [ -f CHANGELOG ]; then
            echo "Reading CHANGELOG file..."
            
            # Read the CHANGELOG directly without complex escaping
            # The action-gh-release action can handle markdown content
            changelog_content=$(cat CHANGELOG)
            
            # Escape $ characters for GitHub Actions
            escaped_content=$(echo "$changelog_content" | sed 's/\$/\$\$/g')
            
            echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
            echo "$escaped_content" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "Successfully read CHANGELOG"
          else
            echo "CHANGELOG file not found, using default message"
            echo "changelog_content=No changelog available for this release." >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Prepare release files
        id: prepare_files
        run: |
          files=""
          
          # Add CurseForge file if generated
          if [ "${{ github.event.inputs.curseforge_build }}" == "true" ] && [ -n "${{ steps.curseforge_export.outputs.curseforge_file }}" ]; then
            files="$files NTNH/${{ steps.curseforge_export.outputs.curseforge_file }}"
            echo "Adding CurseForge file: NTNH/${{ steps.curseforge_export.outputs.curseforge_file }}"
          fi
          
          # Add Modrinth file if generated
          if [ "${{ github.event.inputs.modrinth_build }}" == "true" ] && [ -n "${{ steps.modrinth_export.outputs.modrinth_file }}" ]; then
            files="$files NTNH/${{ steps.modrinth_export.outputs.modrinth_file }}"
            echo "Adding Modrinth file: NTNH/${{ steps.modrinth_export.outputs.modrinth_file }}"
          fi
          
          # Add Native file if generated
          if [ "${{ github.event.inputs.native_build }}" == "true" ] && [ -n "${{ steps.native_export.outputs.native_file }}" ]; then
            files="$files NTNH/${{ steps.native_export.outputs.native_file }}"
            echo "Adding Native file: NTNH/${{ steps.native_export.outputs.native_file }}"
          fi
          
          # Always add Mary-TTS.zip if it exists
          if [ "${{ steps.marytts_check.outputs.marytts_exists }}" == "true" ]; then
            files="$files NTNH/${{ steps.marytts_check.outputs.marytts_file }}"
            echo "Adding Mary-TTS.zip to release files"
          fi
          
          # Trim leading space
          files=$(echo "$files" | sed 's/^ //')
          
          if [ -z "$files" ]; then
            echo "No build files were generated. At least one build type must be selected."
            exit 1
          fi
          
          echo "release_files=$files" >> $GITHUB_OUTPUT
          echo "Release files to upload: $files"
        shell: bash

      # NEW STEP: Copy files to the root directory for reliable upload
      - name: Copy release files to root
        run: |
          for file in ${{ steps.prepare_files.outputs.release_files }}; do
            echo "Copying $file to root directory..."
            cp "$file" ./
          done
          ls -la *.zip *.mrpack || echo "No .zip or .mrpack files found in root."

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: v${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.changelog_content }}
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          # Point to files in the root directory now
          files: ${{ steps.prepare_files.outputs.release_files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push version changes (optional)
        if: ${{ github.ref == format('refs/heads/{0}', github.event.inputs.branch) }}
        run: |
          cd NTNH
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add pack.toml index.toml
          git commit -m "Update version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push origin ${{ github.event.inputs.branch }} || echo "Push failed - might need manual merge"
        shell: bash