name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from (default: main)'
        required: false
        default: 'main'
      version:
        description: 'Version number (X.X.X)'
        required: true
      build_native:
        description: 'Build Native version'
        type: boolean
        required: false
        default: true
      build_curseforge:
        description: 'Build CurseForge version'
        type: boolean
        required: false
        default: true
      build_modrinth:
        description: 'Build Modrinth version'
        type: boolean
        required: false
        default: true
      release_type:
        description: 'Release type'
        type: choice
        options:
        - release
        - pre-release
        - latest-release
        required: true
        default: 'release'

env:
  PACK_NAME: 'NTNH'  # Pack name prefix for zip files
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Default token has read permissions
  # For write permissions, you'll need to create a PAT with repo permissions and store it as a secret
  # PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  setup-and-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      commit_hash: ${{ steps.get-commit.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          # Use personal access token for write permissions if needed
          # token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'  # packwiz requires Go 1.23+

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "PATH=$HOME/go/bin:$PATH" >> $GITHUB_ENV

      - name: Update version in pack.toml
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Setting version to: $VERSION"
          # Check if pack.toml exists
          if [ ! -f pack.toml ]; then
            echo "Error: pack.toml not found in repository root"
            exit 1
          fi
          # Update version using sed (handles both single and double quotes)
          sed -i "s/^version\s*=\s*.*/version = \"$VERSION\"/" pack.toml
          echo "Updated pack.toml:"
          cat pack.toml
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run packwiz refresh
        run: |
          packwiz refresh
          # Commit the changes made by packwiz
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.toml mods/*.toml 2>/dev/null || true
          git commit -m "Update index after version change to ${{ github.event.inputs.version }}" || echo "No changes to commit"

      - name: Commit and push version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pack.toml
          git commit -m "Update version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
          # Only push if we have write permissions
          if [ -n "${{ secrets.PERSONAL_ACCESS_TOKEN }}" ]; then
            git push origin ${{ github.event.inputs.branch || 'main' }}
          else
            echo "Skipping push - no write permissions available"
          fi

      - name: Get commit hash
        id: get-commit
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Current commit: $COMMIT_HASH"

  build-native:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_native == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "PATH=$HOME/go/bin:$PATH" >> $GITHUB_ENV

      - name: Export Native modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-Native.zip"
          echo "Exporting Native modpack to $OUTPUT_FILE"
          
          # Create a temporary directory for Native build
          mkdir -p native_build
          
          # Export the modpack
          packwiz export --output "$OUTPUT_FILE" --format zip
          
          # Extract the zip to clean it up
          unzip "$OUTPUT_FILE" -d native_build
          
          # Remove all .toml files from mods directory and delete corresponding .jar files
          echo "Cleaning up Native build..."
          for toml_file in native_build/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="native_build/mods/${base_name}.jar"
              
              echo "Processing: $base_name"
              echo "  - Found TOML: $toml_file"
              
              # Remove the .toml file
              rm "$toml_file"
              echo "  - Removed TOML file"
              
              # Remove the corresponding .jar file if it exists
              if [ -f "$jar_file" ]; then
                rm "$jar_file"
                echo "  - Removed duplicate JAR file"
              else
                echo "  - No duplicate JAR file found"
              fi
            fi
          done
          
          # Remove any remaining .toml files from other directories
          find native_build -name "*.toml" -type f -delete
          echo "Removed all remaining TOML files"
          
          # Recreate the cleaned zip
          cd native_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          # Clean up temporary directory
          rm -rf native_build
          
          echo "Native build cleaned and optimized: $OUTPUT_FILE"

      - name: Upload Native artifact
        uses: actions/upload-artifact@v3
        with:
          name: native-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip"
          retention-days: 1

  build-curseforge:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_curseforge == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "PATH=$HOME/go/bin:$PATH" >> $GITHUB_ENV

      - name: Export CurseForge modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-CurseForge.zip"
          echo "Exporting CurseForge modpack..."
          
          # Create temporary directory
          mkdir -p cf_build
          
          # Export for CurseForge
          packwiz cf export
          
          # Rename the exported file
          mv export.zip "$OUTPUT_FILE"
          
          # Extract to clean up duplicate files
          unzip "$OUTPUT_FILE" -d cf_build
          
          # Remove duplicate .jar files when .toml files exist
          echo "Cleaning up CurseForge build - removing duplicate JARs..."
          for toml_file in cf_build/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="cf_build/mods/${base_name}.jar"
              
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate JAR for: $base_name"
                rm "$jar_file"
              fi
            fi
          done
          
          # Recreate the cleaned zip
          cd cf_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          # Clean up
          rm -rf cf_build
          
          echo "CurseForge build cleaned: $OUTPUT_FILE"

      - name: Upload CurseForge artifact
        uses: actions/upload-artifact@v3
        with:
          name: curseforge-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"
          retention-days: 1

  build-modrinth:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_modrinth == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "PATH=$HOME/go/bin:$PATH" >> $GITHUB_ENV

      - name: Export Modrinth modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-Modrinth.zip"
          echo "Exporting Modrinth modpack..."
          
          # Create temporary directory
          mkdir -p mr_build
          
          # Export for Modrinth
          packwiz mr export
          
          # Rename the exported file
          mv export.mrpack "$OUTPUT_FILE"
          
          # Extract to clean up duplicate files
          unzip "$OUTPUT_FILE" -d mr_build
          
          # Remove duplicate .jar files when .toml files exist
          echo "Cleaning up Modrinth build - removing duplicate JARs..."
          for toml_file in mr_build/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="mr_build/mods/${base_name}.jar"
              
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate JAR for: $base_name"
                rm "$jar_file"
              fi
            fi
          done
          
          # Recreate the cleaned zip
          cd mr_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          # Clean up
          rm -rf mr_build
          
          echo "Modrinth build cleaned: $OUTPUT_FILE"

      - name: Upload Modrinth artifact
        uses: actions/upload-artifact@v3
        with:
          name: modrinth-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"
          retention-days: 1

  create-release:
    needs: 
      - setup-and-version
      - build-native
      - build-curseforge
      - build-modrinth
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Get changelog content
        id: get-changelog
        run: |
          CHANGELOG_FILE="CHANGELOG.md"
          if [ -f "$CHANGELOG_FILE" ]; then
            CHANGELOG_CONTENT=$(cat "$CHANGELOG_FILE")
            # Escape special characters for GitHub Actions
            CHANGELOG_CONTENT="${CHANGELOG_CONTENT//'%'/'%25'}"
            CHANGELOG_CONTENT="${CHANGELOG_CONTENT//$'\n'/'%0A'}"
            CHANGELOG_CONTENT="${CHANGELOG_CONTENT//$'\r'/'%0D'}"
            echo "changelog_content=$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "Successfully read CHANGELOG.md"
          else
            echo "changelog_content=No changelog available for version ${{ needs.setup-and-version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "Warning: CHANGELOG.md not found"
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup-and-version.outputs.version }}
          name: ${{ needs.setup-and-version.outputs.version }}
          body: ${{ steps.get-changelog.outputs.changelog_content }}
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          # Files to attach - include Mary-TTS.zip if it exists
          files: |
            ${{ github.workspace }}/Mary-TTS.zip || true
            artifacts/native-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip
            artifacts/curseforge-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip
            artifacts/modrinth-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        run: |
          echo "Cleaning up downloaded artifacts..."
          rm -rf artifacts
          echo "Cleanup complete"