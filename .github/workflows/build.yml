name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'experiments/packwiz'
        type: string
      version:
        description: 'Version tag (e.g. 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - pre-release
          - latest
      curseforge_build:
        description: 'Generate CurseForge build'
        required: true
        default: 'true'
        type: boolean
      modrinth_build:
        description: 'Generate Modrinth build'
        required: true
        default: 'true'
        type: boolean

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: Nuclear-Tech-New-Horizons/NTNH
          ref: ${{ github.event.inputs.branch }}
          path: NTNH
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
        env:
          GOPATH: /home/runner/go

      - name: Set up packwiz environment
        run: |
          echo "/home/runner/go/bin" >> $GITHUB_PATH
        shell: bash

      - name: Run CurseForge export (if selected)
        id: curseforge_export
        if: ${{ github.event.inputs.curseforge_build == 'true' }}
        run: |
          cd NTNH
          packwiz curseforge export
          # Find the generated ZIP file
          export_file=$(find . -maxdepth 1 -name "*.zip" -print -quit)
          if [ -z "$export_file" ]; then
            echo "No ZIP file found after CurseForge export"
            exit 1
          fi
          echo "curseforge_file=${export_file#./}" >> $GITHUB_OUTPUT
          echo "CurseForge build generated: ${export_file#./}"
        shell: bash

      - name: Run Modrinth export (if selected)
        id: modrinth_export
        if: ${{ github.event.inputs.modrinth_build == 'true' }}
        run: |
          cd NTNH
          packwiz modrinth export
          # Find the generated ZIP file
          export_file=$(find . -maxdepth 1 -name "*.zip" -print -quit)
          if [ -z "$export_file" ]; then
            echo "No ZIP file found after Modrinth export"
            exit 1
          fi
          echo "modrinth_file=${export_file#./}" >> $GITHUB_OUTPUT
          echo "Modrinth build generated: ${export_file#./}"
        shell: bash

      - name: Read CHANGELOG
        id: changelog
        run: |
          cd NTNH
          if [ -f CHANGELOG ]; then
            # Read CHANGELOG and escape special characters for GitHub Actions
            changelog_content=$(cat CHANGELOG | sed 's/%/%25/g; s/\n/%0A/g; s/\r/%0D/g')
            echo "changelog_content=$changelog_content" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG file not found, using default message"
            echo "changelog_content=No changelog available for this release." >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Prepare release files
        id: prepare_files
        run: |
          files=""
          
          # Add CurseForge file if generated
          if [ "${{ github.event.inputs.curseforge_build }}" == "true" ] && [ -n "${{ steps.curseforge_export.outputs.curseforge_file }}" ]; then
            files="${files} NTNH/${{ steps.curseforge_export.outputs.curseforge_file }}"
          fi
          
          # Add Modrinth file if generated
          if [ "${{ github.event.inputs.modrinth_build }}" == "true" ] && [ -n "${{ steps.modrinth_export.outputs.modrinth_file }}" ]; then
            files="${files} NTNH/${{ steps.modrinth_export.outputs.modrinth_file }}"
          fi
          
          # Trim leading space
          files=$(echo "$files" | sed 's/^ //')
          
          echo "release_files=$files" >> $GITHUB_OUTPUT
          
          if [ -z "$files" ]; then
            echo "No build files were generated. At least one build type must be selected."
            exit 1
          fi
          
          echo "Release files to upload: $files"
        shell: bash

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: NTNH v${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.changelog_content }}
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          files: ${{ steps.prepare_files.outputs.release_files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set latest release if needed
        if: github.event.inputs.release_type == 'latest' && github.event.inputs.release_type != 'pre-release'
        run: |
          echo "This release will be set as latest automatically by GitHub since it's not a pre-release."
        shell: bash