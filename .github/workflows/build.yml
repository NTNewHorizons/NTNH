name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from (default: main)'
        required: true
        default: 'main'
      version:
        description: 'Version number (X.X.X)'
        required: true
      build_native:
        description: 'Build Native version'
        type: boolean
        required: true
        default: true
      build_curseforge:
        description: 'Build CurseForge version'
        type: boolean
        required: true
        default: true
      build_modrinth:
        description: 'Build Modrinth version'
        type: boolean
        required: true
        default: true
      release_type:
        description: 'Release type'
        type: choice
        options:
        - release
        - pre-release
        - latest-release
        - artifact
        required: true
        default: 'release'

env:
  PACK_NAME: 'NTNH'

jobs:
  setup-and-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      commit_hash: ${{ steps.get-commit.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT_FOR_PUSH }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Update version in pack.toml
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Setting version to: $VERSION"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pack.toml
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run packwiz refresh
        run: packwiz refresh

      - name: Commit and push version changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          git add pack.toml index.toml
          git commit -m "Update modpack version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push origin ${{ github.event.inputs.branch }}

      - name: Get commit hash
        id: get-commit
        run: echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  build-native:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_native == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT_FOR_PUSH }}

      - name: Create Native modpack zip manually
        run: |
          # Create temp directory structure
          mkdir -p native_temp/mods
          mkdir -p native_temp/config
          mkdir -p native_temp/scripts
          
          # Copy all mods (only .jar files)
          cp mods/*.jar native_temp/mods/ 2>/dev/null || echo "No mods found"
          
          # Copy config files
          cp -r config/* native_temp/config/ 2>/dev/null || echo "No config files found"
          
          # Copy scripts
          cp -r scripts/* native_temp/scripts/ 2>/dev/null || echo "No scripts found"
          
          # Copy other necessary files
          cp pack.png native_temp/ 2>/dev/null || echo "No pack.png found"
          cp options.txt native_temp/ 2>/dev/null || echo "No options.txt found"
          cp server.properties native_temp/ 2>/dev/null || echo "No server.properties found"
          
          # Create the zip file
          cd native_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip" .
          cd ..
          
          # Clean up temp directory
          rm -rf native_temp

      - name: Upload Native artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip"

  build-curseforge:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_curseforge == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT_FOR_PUSH }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Export CurseForge modpack
        run: |
          packwiz cf export
          # Find the actual exported file (it has the pack name with version)
          CURSEFORGE_FILE=$(find . -name "Nuclear Tech: New Horizons-${{ needs.setup-and-version.outputs.version }}.zip" -print -quit)
          if [ -z "$CURSEFORGE_FILE" ]; then
            echo "Could not find CurseForge export file"
            exit 1
          fi
          mv "$CURSEFORGE_FILE" "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"

      - name: Clean up CurseForge zip (remove duplicate .jar files)
        run: |
          mkdir cf_temp
          unzip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip" -d cf_temp
          
          for toml_file in cf_temp/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="cf_temp/mods/${base_name}.jar"
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate jar: $jar_file"
                rm "$jar_file"
              fi
            fi
          done
          
          cd cf_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip" .
          cd ..
          
          rm -rf cf_temp

      - name: Upload CurseForge artifact
        uses: actions/upload-artifact@v4
        with:
          name: curseforge-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"

  build-modrinth:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_modrinth == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT_FOR_PUSH }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Export Modrinth modpack (ignore exit code 1 for manual downloads)
        run: |
          packwiz mr export || true
          # The file still gets generated despite exit code 1
          if [ -f "export.mrpack" ]; then
            mv export.mrpack "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"
          else
            echo "Modrinth export file not found"
            exit 1
          fi

      - name: Clean up Modrinth zip (remove duplicate .jar files)
        run: |
          mkdir mr_temp
          unzip "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip" -d mr_temp
          
          for toml_file in mr_temp/mods/*.toml; do
            if [ -f "$toml_file" ]; then
              base_name=$(basename "$toml_file" .toml)
              jar_file="mr_temp/mods/${base_name}.jar"
              if [ -f "$jar_file" ]; then
                echo "Removing duplicate jar: $jar_file"
                rm "$jar_file"
              fi
            fi
          done
          
          cd mr_temp
          zip -r "../${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip" .
          cd ..
          
          rm -rf mr_temp

      - name: Upload Modrinth artifact
        uses: actions/upload-artifact@v4
        with:
          name: modrinth-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"

  create-release:
    needs:
      - setup-and-version
      - build-native
      - build-curseforge
      - build-modrinth
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release_type != 'artifact' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get changelog content
        id: get-changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_CONTENT=$(cat CHANGELOG.md)
            echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog_content=No changelog available for version ${{ needs.setup-and-version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup-and-version.outputs.version }}
          name: ${{ needs.setup-and-version.outputs.version }}
          body: ${{ steps.get-changelog.outputs.changelog_content }}
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          files: |
            Mary-TTS.zip
            artifacts/native-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip
            artifacts/curseforge-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip
            artifacts/modrinth-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
