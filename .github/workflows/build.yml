name: Build and Release Modpack

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from (default: main)'
        required: false
        default: 'main'
      version:
        description: 'Version number (X.X.X)'
        required: true
      build_native:
        description: 'Build Native version'
        type: boolean
        required: false
        default: true
      build_curseforge:
        description: 'Build CurseForge version'
        type: boolean
        required: false
        default: true
      build_modrinth:
        description: 'Build Modrinth version'
        type: boolean
        required: false
        default: true
      release_type:
        description: 'Release type'
        type: choice
        options:
        - release
        - pre-release
        - latest-release
        required: true
        default: 'release'

env:
  PACK_NAME: 'NTNH'

jobs:
  setup-and-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      commit_hash: ${{ steps.get-commit.outputs.commit_hash }}
      push_successful: ${{ steps.push-changes.outputs.success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0
          # No token needed - will use permissions from repo settings

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'  # packwiz requires Go 1.23+

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Update version in pack.toml
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Setting version to: $VERSION"
          
          # Verify pack.toml exists
          if [ ! -f pack.toml ]; then
            echo "‚ùå pack.toml not found in repository root!"
            exit 1
          fi
          
          # Update version using sed
          sed -i "s/^version\s*=\s*.*/version = \"$VERSION\"/" pack.toml
          echo "‚úÖ Updated pack.toml version to: $VERSION"
          cat pack.toml | grep version
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run packwiz refresh
        run: |
          echo "üîÑ Refreshing packwiz index..."
          packwiz refresh
          echo "‚úÖ Index refreshed successfully"

      - name: Commit and push version changes
        id: push-changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes to commit
          if git diff --exit-code -- pack.toml index.toml; then
            echo "‚è≠Ô∏è No changes detected in pack.toml or index.toml"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git add pack.toml index.toml
          git commit -m "Update version to ${{ github.event.inputs.version }}"
          echo "‚úÖ Changes committed locally"
          
          echo "üöÄ Attempting to push changes to ${{ github.event.inputs.branch || 'main' }}"
          if git push origin ${{ github.event.inputs.branch || 'main' }}; then
            echo "‚úÖ Successfully pushed version changes"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Failed to push changes - continuing workflow anyway"
            echo "success=false" >> $GITHUB_OUTPUT
            # Don't fail the job, just continue
          fi
        continue-on-error: true

      - name: Get commit hash
        id: get-commit
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "üìÑ Current commit hash: $COMMIT_HASH"

  build-native:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_native == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Export and clean Native modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-Native.zip"
          echo "üîß Building Native modpack: $OUTPUT_FILE"
          
          # Create temp directory
          mkdir -p native_build
          
          # Export the modpack
          packwiz export --output "$OUTPUT_FILE" --format zip
          
          # Extract to clean up
          unzip "$OUTPUT_FILE" -d native_build
          
          # Remove all .toml files and corresponding .jar files
          echo "üßπ Cleaning Native build - removing TOML files and duplicates..."
          find native_build/mods -name "*.toml" | while read toml_file; do
            base_name=$(basename "$toml_file" .toml)
            jar_file="native_build/mods/${base_name}.jar"
            
            echo "  üóëÔ∏è  Processing: $base_name"
            echo "  üóëÔ∏è  Removing TOML: $toml_file"
            rm "$toml_file"
            
            if [ -f "$jar_file" ]; then
              echo "  üóëÔ∏è  Removing duplicate JAR: $jar_file"
              rm "$jar_file"
            fi
          done
          
          # Remove any remaining .toml files from other directories
          find native_build -name "*.toml" -type f -delete
          
          # Create optimized zip
          cd native_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          # Cleanup
          rm -rf native_build
          
          echo "‚úÖ Native build completed: $OUTPUT_FILE"
          ls -lh "$OUTPUT_FILE"

      - name: Upload Native artifact
        uses: actions/upload-artifact@v3
        with:
          name: native-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip"
          retention-days: 1

  build-curseforge:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_curseforge == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Export and clean CurseForge modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-CurseForge.zip"
          echo "üîß Building CurseForge modpack: $OUTPUT_FILE"
          
          mkdir -p cf_build
          
          # Export for CurseForge
          packwiz cf export
          mv export.zip "$OUTPUT_FILE"
          
          # Extract and clean duplicates
          unzip "$OUTPUT_FILE" -d cf_build
          
          echo "üßπ Cleaning CurseForge build - removing duplicate JARs..."
          find cf_build/mods -name "*.toml" | while read toml_file; do
            base_name=$(basename "$toml_file" .toml)
            jar_file="cf_build/mods/${base_name}.jar"
            
            if [ -f "$jar_file" ]; then
              echo "  üóëÔ∏è  Removing duplicate JAR for: $base_name"
              rm "$jar_file"
            fi
          done
          
          # Recreate zip
          cd cf_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          rm -rf cf_build
          
          echo "‚úÖ CurseForge build completed: $OUTPUT_FILE"
          ls -lh "$OUTPUT_FILE"

      - name: Upload CurseForge artifact
        uses: actions/upload-artifact@v3
        with:
          name: curseforge-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip"
          retention-days: 1

  build-modrinth:
    needs: setup-and-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_modrinth == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Export and clean Modrinth modpack
        run: |
          VERSION="${{ needs.setup-and-version.outputs.version }}"
          OUTPUT_FILE="${{ env.PACK_NAME }}-${VERSION}-Modrinth.zip"
          echo "üîß Building Modrinth modpack: $OUTPUT_FILE"
          
          mkdir -p mr_build
          
          # Export for Modrinth
          packwiz mr export
          mv export.mrpack "$OUTPUT_FILE"
          
          # Extract and clean duplicates
          unzip "$OUTPUT_FILE" -d mr_build
          
          echo "üßπ Cleaning Modrinth build - removing duplicate JARs..."
          find mr_build/mods -name "*.toml" | while read toml_file; do
            base_name=$(basename "$toml_file" .toml)
            jar_file="mr_build/mods/${base_name}.jar"
            
            if [ -f "$jar_file" ]; then
              echo "  üóëÔ∏è  Removing duplicate JAR for: $base_name"
              rm "$jar_file"
            fi
          done
          
          # Recreate zip
          cd mr_build
          zip -r "../$OUTPUT_FILE" .
          cd ..
          
          rm -rf mr_build
          
          echo "‚úÖ Modrinth build completed: $OUTPUT_FILE"
          ls -lh "$OUTPUT_FILE"

      - name: Upload Modrinth artifact
        uses: actions/upload-artifact@v3
        with:
          name: modrinth-build
          path: "${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip"
          retention-days: 1

  create-release:
    needs: 
      - setup-and-version
      - build-native
      - build-curseforge
      - build-modrinth
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Get changelog content
        id: get-changelog
        run: |
          CHANGELOG_FILE="CHANGELOG.md"
          if [ -f "$CHANGELOG_FILE" ]; then
            CHANGELOG_CONTENT=$(cat "$CHANGELOG_FILE")
            echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully read CHANGELOG.md"
          else
            echo "‚ö†Ô∏è CHANGELOG.md not found - using default message"
            echo "changelog_content=Release ${{ needs.setup-and-version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup-and-version.outputs.version }}
          name: ${{ needs.setup-and-version.outputs.version }}
          body: ${{ steps.get-changelog.outputs.changelog_content }}
          prerelease: ${{ github.event.inputs.release_type == 'pre-release' }}
          files: |
            artifacts/native-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Native.zip
            artifacts/curseforge-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-CurseForge.zip
            artifacts/modrinth-build/${{ env.PACK_NAME }}-${{ needs.setup-and-version.outputs.version }}-Modrinth.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up artifacts..."
          rm -rf artifacts
          echo "‚úÖ Workflow completed successfully!"